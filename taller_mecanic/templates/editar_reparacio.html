{% extends 'layouts/base.html' %}

{% load static %}

{% block content %}
{% include 'layouts/nav.html' %}
<style>
    .titled-border {
        border: 1px solid #ced4da;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        position: relative;
    }
  
    .title-container {
        position: absolute;
        top: -15px; /* Ajusta este valor según sea necesario */
        background-color: white; /* Esto cubre la línea del borde detrás del título */
        padding: 0 5px; /* Añade un pequeño relleno para el título */
    }

    .title {
        font-weight: bold;
    }

    .b_elimina_filtre{
        width: 45px;
        height: 45px;
        color: rgba(236, 169, 23, 0.918); 
        background-color: #3f3e3d;border:0px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        transition: background-color 0.3s;
        
    }

    .b_elimina_filtre:hover{
        background-color: rgba(236, 169, 23, 0.918); 
        color: #3f3e3d;border:0px;
    }

    .b_elimina_filtre:disabled {
        background-color: rgba(238, 204, 129, 0.918); 
        color: #3f3e3d;border:0px; /* Color de texto más claro cuando está deshabilitado */
        cursor: not-allowed; /* Cambia el cursor cuando está deshabilitado */
    }

    .error{
        color: red;
        font-size: 12px;
    }

    .rounded-border {
        border: 1px solid #ced4da;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .mi-elemento {
        padding: 10px 20px; /* Ajusta el relleno según sea necesario */
        border-radius: 10px; /* Ajusta el radio de los bordes según sea necesario */
        border: 2px solid #4e4e4e; /* Utiliza el color más oscuro para el borde */
        /*box-shadow: 0 0 10px #3f3e3d; /* Utiliza el color más oscuro para el sombreado */
    }


    .feines_mecanic{
        margin-bottom:20px;
    }
    

   
</style>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<body>

    <div class="row">
        
        <div class="col-lg-12 col-xs-12" style="margin-left:50px;margin-bottom:10px;"><h2><i class="fa-solid fa-wrench"></i> Reparació {{ reparacio.id }}</h2></div>
        
        <div class="col-lg-1 col-xs-1"></div>
        
    </div>

    <div class="container">
        <div class="row">
        {% csrf_token %}
          <!-- Columna con select y label -->
          
          <!-- Columna con inputs en estructura enmarcada -->
          <div class="col-lg-6 col-xs-12">
            <div class="rounded-border">
                <div class="row">
                    <h4>&nbsp;&nbsp;<i class="fa-solid fa-user"></i> Client</h4>
                </div>
                <br/>
                <div class="row">
                    <div class="col-md-6">
                    <input type="text" class="form-control mb-2" id="client" disabled value="{{ client.nom }} {{ client.cognoms}}">
                    </div>
                    <div class="col-md-6">
                    <input type="text" class="form-control mb-2" id="nif" disabled value="{{ client.nif }}">
                    </div>
                </div>
              <div class="row">
                <div class="col-md-6">
                  <input type="text" class="form-control mb-2" id="telf" disabled value="{{ client.telefon }}">
                </div>
                <div class="col-md-6">
                  <input type="text" class="form-control mb-2" id="email" disabled value="{{ client.email }}">
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                    <input type="text" class="form-control mb-2" id="direccio" disabled value="{{ client.direccio }} - {{ client.ciutat }} ( {{ client.codi_postal }} )">
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-xs-12">
            <div class="rounded-border">
                <div class="row">
                    <h4>&nbsp;&nbsp;<i class="fa-solid fa-car"></i> Vehicle</h4>
                </div>
                <br/>
                <div class="row">
                    <div class="col-md-12">
                        <input type="text" class="form-control mb-2" id="marca_model" disabled value="{{ vehicle.nom }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                    <input type="text" class="form-control mb-2" id="matricula" disabled value="{{ vehicle.matricula }}">
                    </div>
                    <div class="col-md-6">
                    <input type="text" class="form-control mb-2" id="kms" disabled value="{{ vehicle.kms }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <input type="text" class="form-control mb-2" style="visibility:hidden">
                    </div>
                </div>
              
            </div>
          </div>
        </div>


        <div class="row" id="div_dtl_select">
            <h5>Escull el tipus de feina a realitzar: </h5>
            <select class="js-example-basic-single" id="definicio_tipus_linia" style="width: 220px;">
                <option value="-1">Selecciona...</option>
                {% for dtl in definicio_tipus_linia %}
                    <option value="{{ dtl.id }}">{{ dtl.nom }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Diferents tipus de linia -->
        <div class="col-lg-12 col-xs-12">&nbsp;</div>

        <div class="titled-border" id="d_ac">
            <div class="title-container">
              <div class="title">Altres conceptes</div>
            </div>
            <div class="container" style="margin-top:10px;">
                <div class="row">
                    <div class="col-lg-1 col-xs-1">
                        <label><span class="text-danger">*</span>Descripció:</label>
                    </div>
                    <div class="col-lg-4 col-xs-4" style="margin-left:10px;">
                        <input type="text" class="form-control mb-2" id="desc_ac" />
                    </div>
                    <div class="col-lg-1 col-xs-1">
                        <label>Quantitat:</label>
                    </div>
                    <div class="col-lg-1 col-xs-1">
                        <input type="text" class="form-control mb-2" id="qt_ac" value="1" />
                        <div id="ac_qt_error" class="error"></div>
                    </div>
                    
                    <div class="col-lg-1 col-xs-1">
                        <label>Preu:</label>
                    </div>
                    <div class="col-lg-2 col-xs-2">
                        <input type="text" class="form-control mb-2" id="preu_ac" />
                        <div id="ac_preu_error" class="error"></div>
                    </div> 
                    <div class="col-lg-1 col-xs-1">
                        <button class="b_elimina_filtre" title="Crear reparació" id="add_ac" style="margin-left: 50px; margin-right: 50px;margin-bottom:20px;" disabled>
                            <i class="fa-solid fa-plus fa-xl"></i>
                        </button>
                    </div>
                    
                </div>
            </div>
        </div>
        
        <div class="titled-border" id="d_p">
            <div class="title-container">
              <div class="title">Packs</div>
            </div>
            <div class="container" style="margin-top:10px;">
                <div class="row">
                    <div class="col-lg-1 col-xs-1">
                        <label><span class="text-danger">*</span>Pack:</label>
                    </div>
                    <div class="col-lg-5 col-xs-5">
                        <select class="js-example-basic-single" id="packs" style="width: 320px;">
                            <option value="-1">Selecciona...</option>
                        {% for p in packs %}
                            <option value="{{ p.id }}">{{ p.nom }}</option>
                        {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-1 col-xs-1">
                        <label>Preu:</label>
                    </div>
                    <div class="col-lg-2-col-xs-2">
                        <input type="text" class="form-control mb-2" id="preu_p" disabled/>
                    </div>
                    <div class="col-lg-1 col-xs-1">&nbsp;</div>
                    <div class="col-lg-1 col-xs-1">
                        <button class="b_elimina_filtre" title="Crear reparació" id="add_p" style="margin-left: 50px; margin-right: 50px;margin-bottom:20px;" disabled>
                            <i class="fa-solid fa-plus fa-xl"></i>
                        </button>
                    </div>
                    
                </div>
            </div>
        </div>
        

        <div class="titled-border" id="d_pr">
            <div class="title-container">
              <div class="title">Peces recanvi</div>
            </div>
            <div class="container" style="margin-top:10px;">
                <div class="row">
                    <div class="col-lg-1 col-xs-1">
                        <label><span class="text-danger">*</span>Peça:</label>
                    </div>
                    <div class="col-lg-4 col-xs-4">
                        <input type="text" class="form-control mb-2" id="pesa_pr" />
                    </div>
                    <div class="col-lg-2 col-xs-2">
                        <label><span class="text-danger">*</span>Codi fabricant:</label>
                    </div>
                    <div class="col-lg-2 col-xs-2">
                        <input type="text" class="form-control mb-2" id="codfab_pr" />
                    </div>
                    <div class="col-lg-1 col-xs-1">
                        <label>Quantitat:</label>
                    </div>
                    <div class="col-lg-1 col-xs-1">
                        <input type="text" class="form-control mb-2" id="qt_pr" value="1"/>
                        <div id="pr_qt_error" class="error"></div>
                    </div>
                    <div class="col-lg-1 col-xs-1">&nbsp;</div>
                    <div class="col-lg-1 col-xs-1">
                        <label>Preu:</label>
                    </div>
                    <div class="col-lg-2 col-xs-2">
                        <input type="text" class="form-control mb-2" id="preu_pr" />
                        <div id="pr_preu_error" class="error"></div>
                    </div>
                    <div class="col-lg-7 col-xs-7"></div>
                    <div class="col-lg-1 col-xs-1">
                        <button class="b_elimina_filtre" title="Crear reparació" id="add_pr" style="margin-left: 50px; margin-right: 50px;margin-bottom:20px;" disabled>
                            <i class="fa-solid fa-plus fa-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="titled-border" id="d_fm">
            <div class="title-container">
              <div class="title">Feines mecànic</div>
            </div>
            <div class="container" style="margin-top:10px;">
                <div class="row">
                    <div class="col-lg-1 col-xs-1">
                        <label><span class="text-danger">*</span>Descripció:</label>
                    </div>
                    <div class="col-lg-4 col-xs-4" style="margin-left:10px;">
                        <input type="text" class="form-control mb-2" id="desc_fm" />
                    </div>
                    <div class="col-lg-1 col-xs-1">
                        <label>Quantitat:</label>
                    </div>
                    <div class="col-lg-1 col-xs-1">
                        <input type="text" class="form-control mb-2" id="qt_fm" value="1"/>
                        <div id="fm_qt_error" class="error"></div>
                    </div>
                    
                    <div class="col-lg-1 col-xs-1">
                        <label>Preu:</label>
                    </div>
                    <div class="col-lg-2 col-xs-2">
                        <input type="text" class="form-control mb-2" id="preu_fm" />
                        <div id="fm_preu_error" class="error"></div>
                    </div> 
                    <div class="col-lg-1 col-xs-1">
                        <button class="b_elimina_filtre" title="Crear reparació" id="add_fm" style="margin-left: 50px; margin-right: 50px;margin-bottom:20px;" disabled>
                            <i class="fa-solid fa-plus fa-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div style="margin-bottom:20px;" class="container" id="d_t_feines_reparacio">
        <h4><i class="fa-solid fa-wrench"></i> Feines de la reparació</h4>
    </div>
<!---->
    <div class="container">
        <div style="padding-left:20px;padding-right:20px;padding-top:30px;margin-bottom:10px;" class="mi-elemento" id="feines_reparacio">

            <!--
            <div class="titled-border feines_mecanic" id="id-d_fm" >
                <div class="title-container">
                  <div class="title">Feines mecànic</div>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-lg-1 col-xs-1">
                            <label><span class="text-danger">*</span>Descripció:</label>
                        </div>
                        <div class="col-lg-4 col-xs-4 ml-3" >
                            <input type="text" class="form-control mb-2" id="id-desc_fm" />
                        </div>
                        <div class="col-lg-1 col-xs-1">
                            <label>Quantitat:</label>
                        </div>
                        <div class="col-lg-1 col-xs-1">
                            <input type="text" class="form-control mb-2" id="qt_fm" value="1"/>
                            <div id="id-fm_qt_error" class="error"></div>
                        </div>
                        
                        <div class="col-lg-1 col-xs-1">
                            <label>Preu:</label>
                        </div>
                        <div class="col-lg-2 col-xs-2">
                            <input type="text" class="form-control mb-2" id="preu_fm" />
                            <div id="id-fm_preu_error" class="error"></div>
                        </div> 
                        
                        <div class="col-lg-1 col-xs-1">
                            <button class="b_elimina_filtre" title="Guardar canvis" id="guarda_canvis-id" onclick="f_guardaCanvis(id)" disabled >
                                <i class="fa-solid fa-floppy-disk fa-xl"></i>
                            </button>
                        </div>
                        <div class="col-lg-1 col-xs-1">
                            <button class="b_elimina_filtre" title="Eliminar feina" id="elimina_feina-id" onclick="f_eliminaTipusFeina(id)" disabled>
                                <i class="fa-solid fa-trash fa-xl"></i>
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="titled-border feines_mecanic" id="d_pr">
                <div class="title-container">
                  <div class="title">Peces recanvi</div>
                </div>
                <div class="container" style="margin-top:10px;">
                    <div class="row">
                        <div class="col-lg-1 col-xs-1">
                            <label><span class="text-danger">*</span>Peça:</label>
                        </div>
                        <div class="col-lg-4 col-xs-4">
                            <input type="text" class="form-control mb-2" id="pesa_pr" />
                        </div>
                        <div class="col-lg-2 col-xs-2">
                            <label><span class="text-danger">*</span>Codi fabricant:</label>
                        </div>
                        <div class="col-lg-2 col-xs-2">
                            <input type="text" class="form-control mb-2" id="codfab_pr" />
                        </div>
                        <div class="col-lg-1 col-xs-1">
                            <label>Quantitat:</label>
                        </div>
                        <div class="col-lg-1 col-xs-1">
                            <input type="text" class="form-control mb-2" id="qt_pr" value="1"/>
                            <div id="pr_qt_error" class="error"></div>
                        </div>
                        <div class="col-lg-1 col-xs-1">&nbsp;</div>
                        <div class="col-lg-1 col-xs-1">
                            <label>Preu:</label>
                        </div>
                        <div class="col-lg-2 col-xs-2">
                            <input type="text" class="form-control mb-2" id="preu_pr" />
                            <div id="pr_preu_error" class="error"></div>
                        </div>
                        <div class="col-lg-7 col-xs-7"></div>
                        <div class="col-lg-1 col-xs-1">
                            <button class="b_elimina_filtre" title="Crear reparació" id="add_pr" style="margin-left: 50px; margin-right: 50px;margin-bottom:20px;" disabled>
                                <i class="fa-solid fa-plus fa-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="titled-border feines_mecanic" id="d_p">
                <div class="title-container">
                  <div class="title">Packs</div>
                </div>
                <div class="container" style="margin-top:10px;">
                    <div class="row">
                        <div class="col-lg-1 col-xs-1">
                            <label><span class="text-danger">*</span>Pack:</label>
                        </div>
                        <div class="col-lg-5 col-xs-5">
                            <select class="js-example-basic-single" id="packs" style="width: 320px;">
                                <option value="-1">Selecciona...</option>
                            {% for p in packs %}
                                <option value="{{ p.id }}">{{ p.nom }}</option>
                            {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-1 col-xs-1">
                            <label>Preu:</label>
                        </div>
                        <div class="col-lg-2-col-xs-2">
                            <input type="text" class="form-control mb-2" id="preu_p" disabled/>
                        </div>
                        <div class="col-lg-1 col-xs-1">&nbsp;</div>
                        <div class="col-lg-1 col-xs-1">
                            <button class="b_elimina_filtre" title="Crear reparació" id="add_p" style="margin-left: 50px; margin-right: 50px;margin-bottom:20px;" disabled>
                                <i class="fa-solid fa-plus fa-xl"></i>
                            </button>
                        </div>
                        
                    </div>
                </div>
            </div>

            <div class="titled-border feines_mecanic" id="d_ac">
                <div class="title-container">
                  <div class="title">Altres conceptes</div>
                </div>
                <div class="container" style="margin-top:10px;">
                    <div class="row">
                        <div class="col-lg-1 col-xs-1">
                            <label><span class="text-danger">*</span>Descripció:</label>
                        </div>
                        <div class="col-lg-4 col-xs-4" style="margin-left:10px;">
                            <input type="text" class="form-control mb-2" id="desc_ac" />
                        </div>
                        <div class="col-lg-1 col-xs-1">
                            <label>Quantitat:</label>
                        </div>
                        <div class="col-lg-1 col-xs-1">
                            <input type="text" class="form-control mb-2" id="qt_ac" value="1" />
                            <div id="ac_qt_error" class="error"></div>
                        </div>
                        
                        <div class="col-lg-1 col-xs-1">
                            <label>Preu:</label>
                        </div>
                        <div class="col-lg-2 col-xs-2">
                            <input type="text" class="form-control mb-2" id="preu_ac" />
                            <div id="ac_preu_error" class="error"></div>
                        </div> 
                        <div class="col-lg-1 col-xs-1">
                            <button class="b_elimina_filtre" title="Crear reparació" id="add_ac" style="margin-left: 50px; margin-right: 50px;margin-bottom:20px;" disabled>
                                <i class="fa-solid fa-plus fa-xl"></i>
                            </button>
                        </div>
                        
                    </div>
                </div>
            </div>

        -->
            
        </div>
    </div>
    


</body>

<script>
    let id_reparacio;
    $(document).ready(function() {
        $('.js-example-basic-single').select2();

        document.getElementById('d_t_feines_reparacio').style.display = "none";

        f_altres_conceptes_escoltadors();
        f_peces_recanvi_escoltadors();
        f_feines_mecanic_escoltadors();

        //Inicialment amagar possibilitat afegir linies a la reparació
        //document.getElementById('div_dtl_select').style.display = "none";

        //Inicialment amagar els divs dels 4 tipus de linies
        document.getElementById('d_ac').style.display = "none";
        document.getElementById('d_p').style.display = "none";
        document.getElementById('d_pr').style.display = "none";
        document.getElementById('d_fm').style.display = "none";
 
        //Inicialment fins que no introdueixin client i vehicle no es pot afegir linies de reparació
        //document.getElementById('div_dtl_select').style.display = "none";!!!!

        document.getElementById('add_fm').addEventListener('click',f_afegeixFeinesMecanic);
    });

    function f_afegeixFeinesMecanic(){
        let id_reparacio = "{{ reparacio.id }}";
        console.info('ID-REPARACIO: '+id_reparacio);
        /*
            1.Seleccionar els valors que s'han introduit 
            2.Crida AJAX guardant el valor
            3.Una vegada guardat, crear dinàmicament els valors introduïts(f_generaFeinesMecanic(id_linia_reparacio))
        */

        //1.
        let desc_fm = document.getElementById('desc_fm').value;
        let qt_fm = document.getElementById('qt_fm').value;
        let preu_fm = document.getElementById('preu_fm').value;

        //2.
        var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
        $.ajax({
            type: 'POST',
            url: '/add_feina_mecanic/',
            data: {
                'id_reparacio': id_reparacio,
                'desc': desc_fm,
                'qt': qt_fm,
                'preu': preu_fm,
                'csrfmiddlewaretoken': csrfToken,
            },
            success: function(data) {
                if (data.success) {
                    
                    id_linia_reparacio = data.id_linia_reparacio;

                    Swal.fire({
                        icon: "success",
                        title: "Guardar feina mecànic",
                        text: "La feina del mecànic s'ha guardat correctament",
                    });

                    //Generar el codi dinàmicament
                    f_generaFeinesMecanic(id_linia_reparacio);

                    
                    
                     

                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Guardar feina mecànic",
                        text: "S'ha produït un error guardant la feina del mecànic",
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: "error",
                    title: "Guardar feina mecànic",
                    text: "S'ha produït un error guardant la feina del mecànic",
                });
            }
        });


    }

    function f_generaFeinesMecanic(id_linia_reparacio) {
        // Crea un elemento div principal
        var divPrincipal = document.createElement('div');
        divPrincipal.classList.add('titled-border', 'feines_mecanic');
        divPrincipal.id = id_linia_reparacio + '-d_fm';
    
        // Crea el contenedor del título
        var divTitleContainer = document.createElement('div');
        divTitleContainer.classList.add('title-container');
        var divTitle = document.createElement('div');
        divTitle.classList.add('title');
        divTitle.textContent = 'Feines mecànic';
        divTitleContainer.appendChild(divTitle);
        divPrincipal.appendChild(divTitleContainer);
    
        // Crea el contenedor del formulario
        var divContainer = document.createElement('div');
        divContainer.classList.add('container');
        var divRow = document.createElement('div');
        divRow.classList.add('row');
    
        // Crea los elementos de formulario
        var elementos = [
            { label: 'Descripció:', id: id_linia_reparacio + '-desc_fm', col: 'col-lg-4 col-xs-4 ml-3', tipo: 'text', valor: document.getElementById('desc_fm').value },
            { label: 'Quantitat:', id: id_linia_reparacio + '-qt_fm', col: 'col-lg-1 col-xs-1', tipo: 'text', valor: document.getElementById('qt_fm').value, errorId: id_linia_reparacio + '-fm_qt_error' },
            { label: 'Preu:', id: id_linia_reparacio + '-preu_fm', col: 'col-lg-2 col-xs-2', tipo: 'text', errorId: id_linia_reparacio + '-fm_preu_error', valor: document.getElementById('preu_fm').value }
        ];
    
        elementos.forEach(function(elemento) {
            var divCol = document.createElement('div');
            divCol.classList.add('col-lg-1', 'col-xs-1');
            divCol.style = "margin-right: 20px;";

            var label = document.createElement('label');
            label.textContent = elemento.label;
            divCol.appendChild(label);
    
            var divInputCol = document.createElement('div');
            divInputCol.className = elemento.col.replace(/\s+/g, ''); // Eliminar espacios en blanco del nombre de la clase
            var input = document.createElement('input');
            input.type = elemento.tipo;
            input.classList.add('form-control', 'mb-2');
            input.id = elemento.id;
            if (elemento.valor) {
                input.value = elemento.valor;
            }

            input.addEventListener('input', function() {
                // Aquí puedes poner el código que deseas que se ejecute cuando haya un evento input en este input
                
                console.log('Id: '+ elemento.id+" Error: id: "+elemento.errorId);
            });

            divInputCol.appendChild(input);
            divRow.appendChild(divCol);
            divRow.appendChild(divInputCol);
        });
    
        // Crea los botones
        var botones = [
            { id: id_linia_reparacio + '-guarda_canvis', onclick: 'f_guardaCanvis(' + id_linia_reparacio + ')', icono: 'fa-floppy-disk', param: id_linia_reparacio },
            { id: id_linia_reparacio + '-elimina_feina', onclick: 'f_eliminaTipusFeina(' + id_linia_reparacio + ')', icono: 'fa-trash', param: id_linia_reparacio }
        ];
    
        botones.forEach(function(boton) {
            var divCol = document.createElement('div');
            divCol.classList.add('col-lg-1', 'col-xs-1');
            var button = document.createElement('button');
            button.classList.add('b_elimina_filtre');
            button.title = (boton.id.includes('guarda_canvis')) ? 'Guardar canvis' : 'Eliminar feina';
            button.id = boton.id;

           // Asignar la función directamente al evento click
            button.addEventListener('click', function() {
                if (boton.id.includes('guarda_canvis')) {
                    f_guardaCanvis(boton.param);
                } else {
                    f_eliminaTipusFeina(boton.param);
                }
            });
            //button.disabled = true;
            var icon = document.createElement('i');
            icon.classList.add('fa-solid', boton.icono, 'fa-xl');
            button.appendChild(icon);
            divCol.appendChild(button);
            divRow.appendChild(divCol);
        });
    
        // Agrega la fila al contenedor del formulario
        divContainer.appendChild(divRow);
        divPrincipal.appendChild(divContainer);
    
        var d_feines_reparacio = document.getElementById("feines_reparacio");
        d_feines_reparacio.appendChild(divPrincipal);

        //Netejar camps de text
        document.getElementById('desc_fm').value = "";
        document.getElementById('qt_fm').value = "1";
        document.getElementById('preu_fm').value = "";
    }
    
     

    function f_guardaCanvis(id_linia_reparacio){
        
        let id_reparacio = "{{ reparacio.id }}";

        let desc = document.getElementById(id_linia_reparacio+'-desc_fm').value;
        let qt = document.getElementById(id_linia_reparacio+'-qt_fm').value;
        let preu = document.getElementById(id_linia_reparacio+'-preu_fm').value;

        var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
        $.ajax({
            type: 'POST',
            url: '/editar_feina_mecanic/',
            data: {
                'id_reparacio': id_reparacio,
                'id_linia_reparacio': id_linia_reparacio,
                'desc': desc,
                'qt': qt,
                'preu': preu,
                'csrfmiddlewaretoken': csrfToken,
            },
            success: function(data) {
                if (data.success) {
                    Swal.fire({
                        icon: "success",
                        title: "Guardar canvis feina mecànic",
                        text: "Els canvis s'han guardat correctament",
                    });

                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Guardar canvis feina mecànic",
                        text: "S'ha produït un error guardant els canvis de feina mecànic",
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: "error",
                    title: "Guardar canvis feina mecànic",
                    text: "S'ha produït un error guardant els canvis de feina mecànic",
                });
            }
        });


    }

    function f_eliminaTipusFeina(id_linia_reparacio){
        Swal.fire({
            title: "Estàs segur que vols eliminar el la feina?",
            //text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Elimina"
          }).then((result) => {
            if (result.isConfirmed) {  
                let id_reparacio = "{{ reparacio.id }}";

                var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
                $.ajax({
                    type: 'POST',
                    url: '/eliminar_feina_mecanic/',
                    data: {
                        'id_linia_reparacio': id_linia_reparacio,
                        'csrfmiddlewaretoken': csrfToken,
                    },
                    success: function(data) {
                        if (data.success) {
                            document.getElementById(id_linia_reparacio+'-d_fm').innerHTML = "";
                            document.getElementById(id_linia_reparacio+'-d_fm').style.display = "none";
        
                            Swal.fire({
                                icon: "success",
                                title: "Eliminar feina mecanic",
                                text: "La feina de mecànic s'ha eliminat correctament",
                            });
        
                        } else {
                            Swal.fire({
                                icon: "error",
                                title: "Eliminar feina mecanic",
                                text: "S'ha produït un error eliminant la feina de mecànic",
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: "error",
                            title: "Eliminar feina mecanic",
                            text: "S'ha produït un error eliminant la feina de mecànic",
                        });
                    }
                });
            }
          });


        
    }



    function f_feines_mecanic_escoltadors(){
        //Afegir escoltadors
        document.getElementById('desc_fm').addEventListener('input', f_comprovarFeinesMecanic);
        document.getElementById('qt_fm').addEventListener('input', f_comprovarFeinesMecanic);
        document.getElementById('preu_fm').addEventListener('input', f_comprovarFeinesMecanic);
    }

    function f_comprovarFeinesMecanic(){
        let desc = document.getElementById('desc_fm').value;
        let qt = document.getElementById('qt_fm').value;
        let preu = document.getElementById('preu_fm').value;

        if(desc.length==0){
            document.getElementById('add_fm').disabled = true;
            f_validarPreu(preu,"fm_preu_error");
            f_validarQuantitats(qt,"fm_qt_error");

        }else{    
            document.getElementById('add_fm').disabled = f_validarPreu(preu,"fm_preu_error") || f_validarQuantitats(qt,"fm_qt_error") || (desc.length > 0 ? false : true);
        }
    }

    function f_altres_conceptes_escoltadors(){
        //Afegir escoltadors
        document.getElementById('desc_ac').addEventListener('input', f_comprovaAltresConceptes);
        document.getElementById('qt_ac').addEventListener('input', f_comprovaAltresConceptes);
        document.getElementById('preu_ac').addEventListener('input', f_comprovaAltresConceptes);
    }

    function f_peces_recanvi_escoltadors(){
        document.getElementById('pesa_pr').addEventListener('input',f_comprovaRecanvi);
        document.getElementById('codfab_pr').addEventListener('input',f_comprovaRecanvi);
        document.getElementById('qt_pr').addEventListener('input',f_comprovaRecanvi);
        document.getElementById('preu_pr').addEventListener('input',f_comprovaRecanvi);

    }

    function f_comprovaRecanvi(){
        let pesa = document.getElementById('pesa_pr').value;
        let codfab = document.getElementById('codfab_pr').value;
        let qt = document.getElementById('qt_pr').value;
        let preu = document.getElementById('preu_pr').value;

        if(pesa.length==0 || codfab.length==0){
            document.getElementById('add_pr').disabled = true;
            f_validarPreu(preu,"pr_preu_error");
            f_validarQuantitats(qt,"pr_qt_error");
        }else{
            document.getElementById('add_pr').disabled = f_validarPreu(preu,"pr_preu_error") || f_validarQuantitats(qt,"pr_qt_error") || (pesa.length > 0 ? false : true) || (codfab.length > 0 ? false : true);
        }

    }

    function f_comprovaAltresConceptes(){
        
        /*
            En el moment d'afegir altres conceptes:
            Descripció: Obligatori
            Quantitat: Opcional(Només numeros o be formats d'aquest estil "1.5") -> Validar validarPreusQuantitats
            Preu: Opcional (Només numeros o be formats d'aquest estil "1.5") -> Validar validarPreusQuantitats
        */
        let desc = document.getElementById('desc_ac').value;
        let qt = document.getElementById('qt_ac').value;
        let preu = document.getElementById('preu_ac').value;

        if(desc.length==0){
            document.getElementById('add_ac').disabled = true;
            f_validarPreu(preu,"ac_preu_error");
            f_validarQuantitats(qt,"ac_qt_error");

        }else{    
            document.getElementById('add_ac').disabled = f_validarPreu(preu,"ac_preu_error") || f_validarQuantitats(qt,"ac_qt_error") || (desc.length > 0 ? false : true);
        }
        
    }

    function f_validarQuantitats(quantitat, id) {
        //Validar 0.25 0.5 0.75 o be 1 1.0 
        if(quantitat.length == 0){
            document.getElementById(id).innerHTML = "";
            return false;
        }
        const regex = /^\d+(\.(25|5|75|0))?$/;
    
        if (regex.test(quantitat)==false) {
            document.getElementById(id).innerHTML = "Només permeten números enters o seguit de: .0, .25 o .75";
            return true;
        } else {
            document.getElementById(id).innerHTML = "";
            return false;
        }
        
    }

    function f_validarPreu(preu, id) {
        if(preu.length == 0){
            document.getElementById(id).innerHTML = "";
            return false;
        }
        const regex = /^\d+(\.\d+)?$/;
    
        if (regex.test(preu)==false) {
            console.info('DOCUMENT: '+id);
            document.getElementById(id).innerHTML = "Només es permeten numeros amb la notació decimal amb '.'";
            return true;
        } else {
            document.getElementById(id).innerHTML = "";
            return false;
        }
    }
    
    var e_vehicle = $('#vehicle');
    // Agregar un event listener para el evento change de Select2
    e_vehicle.on('select2:select select2:unselect', function (e) {
        // Obtener los elementos seleccionados
        //var selectedOptions = select.val();
        f_emplenarDadesClient(e_vehicle.val());
       
        f_getVehicle(e_vehicle.val());
        
    });

    var e_client = $('#clients');
    e_client.on('select2:select select2:unselect', function (e) {
        // Obtener los elementos seleccionados
        //var selectedOptions = select.val();
        f_emplenarDadesVehicle(e_client.val());
        f_emplenarDadesClient(e_client.val());
        
        
    });


    function f_guardarReparacionsCapçalera(){
        /*
            Funció que guarda la capçalera de la reparació. Retorna el id de la capçalera que acabem de guardar
            Deshabilita els <select> ya que ja hem guardat la reparació
        */
        console.info('VEHICLE A GUARDAR: '+ e_vehicle.val());
        var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                type: 'POST',
                url: '/add_reparacio/',
                data: {
                    'id_vehicle': e_vehicle.val(),
                    'csrfmiddlewaretoken': csrfToken,
                },
                success: function(data) {
                    if (data.success) {
                        
                        id_reparacio = data.id_reparacio;

                        Swal.fire({
                            icon: "success",
                            title: "Guardar reparació",
                            text: "La reparació s'ha guardat correctament, ja pots afegir les feines a realitzar",
                        });

                        //Mostrar select 
                        document.getElementById('div_dtl_select').style.display = "flex";
                        //No deixar que canvii les dades
                        $('#clients').prop('disabled', true);
                        $('#vehicle').prop('disabled', true);
                         

                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Guardar reparació",
                            text: "S'ha produït un error guardant la reparació",
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: "error",
                        title: "Guardar reparació",
                        text: "S'ha produït un error guardant la reparació",
                    });
                }
            });

    }

    var e_definicio_tipus_linia = $('#definicio_tipus_linia');
    e_definicio_tipus_linia.on('select2:select select2:unselect', function (e) {
        // Obtener los elementos seleccionados
        //var selectedOptions = select.val();
        
        document.getElementById('d_t_feines_reparacio').style.display = "flex";

        if(e_definicio_tipus_linia.val()=="-1"){
            document.getElementById('d_ac').style.display = "none";
            document.getElementById('d_p').style.display = "none";
            document.getElementById('d_pr').style.display = "none";
            document.getElementById('d_fm').style.display = "none";
        }else{
            switch(e_definicio_tipus_linia.val()){
                case "1":
                    //Feines mecànic
                    document.getElementById('d_fm').style.display = "flex";

                    document.getElementById('d_ac').style.display = "none";
                    document.getElementById('d_p').style.display = "none";
                    document.getElementById('d_pr').style.display = "none";
                    break;
                case "2":
                    //Peces recanvi
                    document.getElementById('d_pr').style.display = "flex";

                    document.getElementById('d_ac').style.display = "none";
                    document.getElementById('d_p').style.display = "none";
                    document.getElementById('d_fm').style.display = "none";
                    
                    break;
                case "3":
                    //Packs
                    document.getElementById('d_p').style.display = "flex";

                    document.getElementById('d_ac').style.display = "none";
                    document.getElementById('d_pr').style.display = "none";
                    document.getElementById('d_fm').style.display = "none";

                    break;
                case "4":
                    //Altres conceptes
                    console.info('Altres conceptes');
                    document.getElementById('d_ac').style.display = "flex";

                    document.getElementById('d_p').style.display = "none";
                    document.getElementById('d_pr').style.display = "none";
                    document.getElementById('d_fm').style.display = "none";
                    break;
            }
        }
        console.info(e_definicio_tipus_linia.val()); 
    });

    var e_packs = $('#packs');
    e_packs.on('select2:select select2:unselect', function (e) {
        console.info('aa');
        f_emplenarPreuPack(e_packs.val());
        if(e_packs.val()==-1){
            document.getElementById('add_p').disabled = true;
        }else{
            document.getElementById('add_p').disabled = false;
        }
        
    });

    
    function f_getVehicle(id_vehicle){
        if(id_vehicle=="-1"){
            
        }else{
            var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                type: 'POST',
                url: '/get_vehicle/',
                data: {
                    'id_vehicle': id_vehicle,
                    'csrfmiddlewaretoken': csrfToken,
                },
                success: function(data) {
                    if (data.success) {
                        
                        document.getElementById('marca_model').value = data.vehicle.nom;
                        document.getElementById('matricula').value = data.vehicle.matricula;
                        document.getElementById('kms').value = data.vehicle.kms;

                        document.getElementById('b_guarda_reparacio_cap').disabled = false;
                        

                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Obtenir vehicle",
                            text: "S'ha produït un obtenint les dades del vehicle",
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: "error",
                        title: "Obtenir vehicle",
                        text: "S'ha produït un obtenint les dades del vehicle",
                    });
                }
            });
        }
    }

    function f_emplenarDadesVehicle(id_client){
        
        if(id_client=="-1"){
            
        }else{
            console.info('else')
            var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                type: 'POST',
                url: '/get_dades_vehicle/',
                data: {
                    'id_client': id_client,
                    'csrfmiddlewaretoken': csrfToken,
                },
                success: function(data) {
                    if (data.success) {
                        //Retorn de JSON amb dades filtrades
                        console.info(data);
                        let s_vehicles = document.getElementById('vehicle');
                        s_vehicles.innerHTML = "";

                        for(let i=0; i<data.vehicles.length; i++){
                            var opt = document.createElement("option");
                            
                            opt.text = data.vehicles[i].matricula+" "+data.vehicles[i].nom;
                            opt.value = data.vehicles[i].id; // Asignar un valor, si es necesario
                            s_vehicles.add(opt);
                        }
                        document.getElementById('marca_model').value = data.vehicles[0].nom;
                        document.getElementById('matricula').value = data.vehicles[0].matricula;
                        document.getElementById('kms').value = data.vehicles[0].kms;

                        document.getElementById('b_guarda_reparacio_cap').disabled = false;

                        
                        
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Obtenir vehicles del client",
                            text: "S'ha produït un obtenint els vehicles del client",
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: "error",
                        title: "Obtenir vehicles del client",
                        text: "S'ha produït un obtenint els vehicles del client",
                    });
                }
            });
        }
    }

    function f_emplenarPreuPack(id_pack){

        if(id_pack==-1){
            document.getElementById('preu_p').value = "";
        }else{
            var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                type: 'POST',
                url: '/get_preu_pack/',
                data: {
                    'id_pack': id_pack,
                    'csrfmiddlewaretoken': csrfToken,
                },
                success: function(data) {
                    if (data.success) {
                        //Retorn de JSON amb dades filtrades
                        console.info(data)
                        document.getElementById('preu_p').value = data.preu;
                        
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Obtenir client",
                            text: "S'ha produït un obtenint les dades del client",
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: "error",
                        title: "Obtenir client",
                        text: "S'ha produït un obtenint les dades del client",
                    });
                }
            });
        }
       
    }



    function f_emplenarDadesClient(id_vehicle){

        if(id_vehicle=="-1"){
            //Esborrar tots els camps
            document.getElementById('client').value = "";
            document.getElementById('nif').value = "";
            document.getElementById('telf').value = "";
            document.getElementById('email').value = "";
            document.getElementById('direccio').value = "";

            document.getElementById('marca_model').value = "";
            document.getElementById('kms').value = "";
            document.getElementById('matricula').value = "";

            //Mostra el combo dels vehicles ple
            var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                type: 'POST',
                url: '/get_vehicles/',
                data: {
                    'csrfmiddlewaretoken': csrfToken,
                },
                success: function(data) {
                    if (data.success) {
                        //Retorn de JSON amb dades filtrades
                        
                        let s_vehicles = document.getElementById('vehicle');
                        s_vehicles.innerHTML = "";

                        let json_obj = JSON.parse(data.vehicles);
                        var opt = document.createElement("option");
                        opt.text = "Selecciona...";
                        opt.value = "-1";
                        s_vehicles.add(opt);
                        for(let i=0; i<json_obj.length; i++){
                            var opt = document.createElement("option");

                            opt.text = json_obj[i].matricula+" "+json_obj[i].nom;
                            opt.value = json_obj[i].id;
                            s_vehicles.add(opt);
                        }
                        document.getElementById('b_guarda_reparacio_cap').disabled = true;
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Obtenir vehicles",
                            text: "S'ha produït un error obtenint les dades dels vehicles",
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: "error",
                        title: "Obtenir vehicles",
                        text: "S'ha produït un error obtenint les dades dels vehicles",
                    });
                }
            });
            
        }else{
            var csrfToken = $('[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                type: 'POST',
                url: '/get_client/',
                data: {
                    'id_vehicle': id_vehicle,
                    'csrfmiddlewaretoken': csrfToken,
                },
                success: function(data) {
                    if (data.success) {
                        //Retorn de JSON amb dades filtrades
                        console.info(data)
                        document.getElementById('client').value = data.client.nom + " " + data.client.cognoms;
                        document.getElementById('nif').value = data.client.nif;
                        document.getElementById('telf').value = data.client.telefon;
                        document.getElementById('email').value = data.client.email;
                        document.getElementById('direccio').value = data.client.direccio + " - " + data.client.ciutat + " ("+data.client.codi_postal+")"; 
                        //document.getElementById('div_dtl_select').style.display = "flex";
                        
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Obtenir client",
                            text: "S'ha produït un error obtenint les dades del client",
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: "error",
                        title: "Obtenir client",
                        text: "S'ha produït un error obtenint les dades del client",
                    });
                }
            });

        }

        


    }


    


</script>


{% endblock %}